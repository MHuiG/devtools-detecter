{"version":3,"file":"DevtoolsDetecter.js","sources":["../index.js"],"sourcesContent":["const DevtoolsDetecter = (function () {\r\n  let isOpen = false;\r\n  let isOpenForGetterHack = false;\r\n  let debug = false;\r\n  let benchmarkMaxN = 7000000;\r\n  let timingSamplingMaxN = 1000;\r\n  let timer = 500;\r\n  let TimingSamplingCtl = null;\r\n  let GetterHackCtl = null;\r\n\r\n  const Status = () => {\r\n    return isOpen || isOpenForGetterHack;\r\n  }\r\n  const listeners = [];\r\n  const RunListeners = () => {\r\n    for (const listener of listeners) {\r\n      try {\r\n        listener(Status());\r\n      } catch { }\r\n    }\r\n  }\r\n  // 屏幕打印\r\n  const Print = (msg) => {\r\n    if (debug) {\r\n      const div = document.createElement(\"div\");\r\n      div.innerHTML = `${msg}<br>`;\r\n      document.body.appendChild(div);\r\n    }\r\n  }\r\n  // Cats\r\n  const LogCat = console;\r\n  const MathCat = Math;\r\n  const Int8ArrayCat = Int8Array;\r\n  const setIntervalCat = setInterval;\r\n  const ObjectCat = Object;\r\n  const DateCat = Date;\r\n  let performanceCat = false;\r\n  if (typeof performance != \"undefined\") {\r\n    performanceCat = performance;\r\n  }\r\n  const now = () => {\r\n    if (performanceCat) {\r\n      return performanceCat.now();\r\n    } else {\r\n      return +new DateCat;\r\n    }\r\n  }\r\n\r\n  // getter hack check for IE\r\n  const div = document.createElement('div');\r\n  try {\r\n    ObjectCat.defineProperty(div, \"id\", {\r\n      get: () => {\r\n        isOpenForGetterHack = true;\r\n        Print(`**** !!!!!! [Getter Hack] DevTools detected !!!!! ****`);\r\n        RunListeners();\r\n      }\r\n    });\r\n  } catch {\r\n    isOpenForGetterHack = 0;\r\n  }\r\n\r\n  const GetterHack = () => {\r\n    if (isOpenForGetterHack === 0)\r\n      return;\r\n    isOpenForGetterHack = false;\r\n    LogCat.log(div);\r\n    try {\r\n      LogCat.clear();\r\n    } catch { }\r\n  }\r\n  const TimingHack = () => {\r\n    const startTime = now();\r\n    for (let check = 0; check < timingSamplingMaxN; check++) {\r\n      if (!LogCat.log) {\r\n        alert(\"Hacked!\");\r\n      }\r\n      LogCat.log(check);\r\n      try {\r\n        LogCat.clear();\r\n      } catch { }\r\n    }\r\n    return now() - startTime;\r\n  }\r\n  // 平均值\r\n  const Average = (arr) => {\r\n    let sum = 0;\r\n    for (let i = 0; i < arr.length; i++) {\r\n      sum += arr[i];\r\n    }\r\n    return sum / arr.length;\r\n  }\r\n  // 方差\r\n  const Variance = (arr) => {\r\n    let avg = Average(arr);\r\n    let sum = 0;\r\n    for (let i = 0; i < arr.length; i++) {\r\n      sum += MathCat.pow(arr[i] - avg, 2);\r\n    }\r\n    return sum / arr.length;\r\n  }\r\n  // 添加样本\r\n  const AddSample = (arr, item) => {\r\n    arr.push(item);\r\n    if (arr.length > 5) {\r\n      arr.shift();\r\n    }\r\n  }\r\n  // 基准\r\n  let Benchmark = () => {\r\n    const startTime = now();\r\n    const maxn = benchmarkMaxN;\r\n    const pris = new Int8ArrayCat(maxn + 1)\r\n    for (var i = 2; i <= maxn; ++i)\r\n      if (pris[i] === 0)\r\n        for (var j = i * i; j <= maxn; j += i)\r\n          pris[j] = 1;\r\n    const diff = now() - startTime;\r\n    return diff;\r\n  }\r\n  // 采样列表\r\n  const SampleList = [];\r\n  // 平均采样列表\r\n  const AverageSampleList = [];\r\n  // 方差采样列表\r\n  const VarianceSampleList = [];\r\n  // 标记\r\n  let FlagID = -1;\r\n  // 临界水平\r\n  const CriticalLevel = Benchmark();\r\n  // 平均临界水平\r\n  let AverageCriticalLevel = CriticalLevel;\r\n  // 方差临界水平\r\n  let VarianceCriticalLevel = CriticalLevel;\r\n  // 计时采样\r\n  const TimingSampling = () => {\r\n    FlagID++;\r\n    const diff = TimingHack();\r\n    AddSample(SampleList, diff);\r\n    Print(SampleList);\r\n    if (FlagID && FlagID % 5 == 0) {\r\n      const avg = Average(SampleList);\r\n      const sd = Variance(SampleList);\r\n      AddSample(AverageSampleList, avg);\r\n      AddSample(VarianceSampleList, sd);\r\n      Print(`=== Average: ${avg} Variance: ${sd} === `);\r\n      // 平均值大于临界水平 或 采样值成接近临界水平的突增趋势\r\n      if (avg > AverageCriticalLevel || (avg > AverageCriticalLevel * 0.85 && sd > VarianceCriticalLevel && Average([SampleList[0], SampleList[1], SampleList[2]]) < Average([SampleList[1], SampleList[2], SampleList[3]]) && Average([SampleList[1], SampleList[2], SampleList[3]]) < Average([SampleList[2], SampleList[3], SampleList[4]]))) {\r\n        // 检测到 DevTools\r\n        isOpen = true;\r\n        Print(`**** !!!!!! DevTools detected !!!!! ****`);\r\n      } else {\r\n        // 没有检测到 DevTools\r\n        isOpen = false;\r\n        // 微调参数水平\r\n        if (FlagID >= 25) {\r\n          AverageCriticalLevel = Average([MathCat.min(MathCat.max(...AverageSampleList), AverageCriticalLevel), CriticalLevel]);\r\n          VarianceCriticalLevel = Average([MathCat.min(MathCat.max(...VarianceSampleList), VarianceCriticalLevel), CriticalLevel]);\r\n          Print(`=== AverageCriticalLevel: ${AverageCriticalLevel} VarianceCriticalLevel: ${VarianceCriticalLevel} ===`);\r\n        }\r\n      }\r\n    }\r\n    checkEruda();\r\n    RunListeners();\r\n  }\r\n  const checkEruda = () => {\r\n    if (isOpen)\r\n      return\r\n    if (typeof eruda !== 'undefined') {\r\n      if (eruda?._devTools?._isShow === true) {\r\n        isOpen = true;\r\n        Print(`**** !!!!!! [Eruda] DevTools detected !!!!! ****`);\r\n      } else {\r\n        isOpen = false;\r\n      }\r\n    }\r\n  }\r\n\r\n  class DevtoolsDetecter {\r\n    debug() {\r\n      debug = true;\r\n      Print(`ua: ${navigator.userAgent}`)\r\n      Print(`hardwareConcurrency: ${navigator.hardwareConcurrency}`)\r\n      try {\r\n        if (performance && performance.memory) {\r\n          Print(`memory used: ${performance.memory.usedJSHeapSize}`)\r\n          Print(`memory total: ${performance.memory.totalJSHeapSize}`)\r\n          Print(`memory limit: ${performance.memory.jsHeapSizeLimit}`)\r\n        }\r\n      } catch { }\r\n      Print(`Benchmark: ${CriticalLevel}`)\r\n    }\r\n    getStatus() {\r\n      return Status();\r\n    }\r\n    setBenchmarkMaxN(n) {\r\n      benchmarkMaxN = n;\r\n    }\r\n    setTimingSamplingMaxN(n) {\r\n      timingSamplingMaxN = n;\r\n    }\r\n    setBenchmark(callBack) {\r\n      Benchmark = callBack;\r\n    }\r\n    setTimer(t) {\r\n      timer = t;\r\n    }\r\n    addListener(callBack) {\r\n      listeners.push(callBack);\r\n    }\r\n    launch() {\r\n      TimingSamplingCtl = setIntervalCat(TimingSampling, timer);\r\n      GetterHackCtl = setIntervalCat(GetterHack, timer);\r\n    }\r\n    stop() {\r\n      clearInterval(TimingSamplingCtl);\r\n      clearInterval(GetterHackCtl);\r\n    }\r\n  }\r\n  return new DevtoolsDetecter();\r\n})()\r\n\r\nexport default DevtoolsDetecter;"],"names":["isOpen","isOpenForGetterHack","debug","benchmarkMaxN","timingSamplingMaxN","timer","TimingSamplingCtl","GetterHackCtl","Status","listeners","RunListeners","_step","_iterator","_createForOfIteratorHelper","s","n","done","listener","value","err","e","f","Print","msg","div","document","createElement","innerHTML","concat","body","appendChild","LogCat","console","MathCat","Math","Int8ArrayCat","Int8Array","setIntervalCat","setInterval","ObjectCat","Object","DateCat","Date","performanceCat","performance","now","defineProperty","get","_unused2","GetterHack","log","clear","Average","arr","sum","i","length","AddSample","item","push","shift","Benchmark","startTime","maxn","pris","j","diff","SampleList","AverageSampleList","VarianceSampleList","FlagID","CriticalLevel","AverageCriticalLevel","VarianceCriticalLevel","TimingSampling","check","alert","TimingHack","avg","sd","pow","Variance","min","max","checkEruda","_eruda","_eruda$_devTools","eruda","_isShow","_devTools","DevtoolsDetecter3","_classCallCheck","this","key","_debug","navigator","userAgent","hardwareConcurrency","memory","usedJSHeapSize","totalJSHeapSize","jsHeapSizeLimit","callBack","t","clearInterval"],"mappings":"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"}